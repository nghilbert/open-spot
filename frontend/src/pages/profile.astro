---
import BaseLayout from "../layouts/BaseLayout.astro";
import "../assets/styles/profile.css";
import LogoutHeader from "../components/logoutHeader.astro";
import Avatar from "../components/Avatar.astro";
import ProfileDetails from "../components/ProfileDetails.astro";
import ProtectedPanel from "../components/ProtectedPanel.astro";

// Force the server to regenerate the page every request, rather than at `npm run build`.
export const prerender = false;

const res = await fetch(`${Astro.url.origin}/api/user/profile`, {
	headers: {
		Cookie: `session=${Astro.cookies.get("session")?.value}`,
	},
});

if (!res.ok) {
	throw new Error("HTTP ");
}

const user = await res.json();
---

<BaseLayout title="Account">
	<LogoutHeader />
	<main class="flex-center-content mt-5">
		<div class="wrap">
			<div class="topActions">
				<button onclick="window.location.href='/dashboard'" class="btn btn-outline-light" id="backBtn">
					Back to dashboard
				</button>
			</div>
			<section class="card profile" aria-labelledby="profile-heading">
				<Avatar avatarUrl={user.avatarUrl} role={user.role} />
				<ProfileDetails {...user} />
			</section>

			<ProtectedPanel passwordChangedAgo={user.passwordChangedAgo} emailNote={user.emailNote} />
		</div>
	</main>

	<script>
		// Handle logout with fetch (comment out e.preventDefault() to use native form POST instead)
		const form = document.getElementById("logout-form");

		if (form) {
			form.addEventListener("submit", async (e) => {
				e.preventDefault();
				try {
					const res = await fetch("api/user/logout", { method: "POST", credentials: "include" });
					if (res.ok) {
						window.location.href = "../";
					} else {
						alert("Logout failed. Please try again.");
					}
				} catch (err) {
					alert("Network error.");
				}
			});
		}

		// Footer year
		const yearEl = document.getElementById("year");
		if (yearEl) yearEl.textContent = new Date().getFullYear().toString();

		// Example button handlers (replace with real routes/modals)
		document.getElementById("change-password")?.addEventListener("click", () => {
			window.location.href = "/reset_password";
		});

		document.getElementById("setup-2fa")?.addEventListener("click", () => {
			window.location.href = "/settings/2fa";
		});

		document.getElementById("edit-profile")?.addEventListener("click", () => {
			window.location.href = "/edit_profile";
		});

		document.getElementById("change-photo")?.addEventListener("click", () => {
			window.location.href = "/settings/avatar";
		});
	</script>
</BaseLayout>
