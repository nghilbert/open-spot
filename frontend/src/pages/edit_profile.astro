---
import Card from "src/components/Card.astro";
import Layout from "src/layouts/Layout.astro";
import "../assets/colors.css";
---

<Layout title="Open Spot — Edit Profile">
  <div class="shell">
    <header class="nav">
      <div class="brand">
        <img src="/favicon.svg" alt="Open Spot logo" />
        <div class="title">Open Spot — Edit Profile</div>
      </div>
      <div class="navBtns"></div>
    </header>

    <Card title="Profile">
      <form class="body" id="profileForm" autocomplete="on" novalidate>
        <div class="grid-2">
          <div class="field">
            <label class="label" for="name">Name</label>
            <input id="name" name="name" class="input" type="text" placeholder="Full name" required />
          </div>

          <div class="field">
            <label class="label" for="username">Username</label>
            <input id="username" name="username" class="input" type="text" placeholder="username" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label class="label" for="type">Type</label>
            <select id="type" name="type" class="select" required>
              <option value="Driver">Driver</option>
              <option value="Cyclist">Cyclist</option>
            </select>
            <div class="hint">Selecting <b>Driver</b> enables permit selection.</div>
          </div>

          <!-- Permit: only shown when Type = Driver -->
          <div class="field hidden" id="permitField">
            <label class="label" for="permit">Permit</label>
            <select id="permit" name="permit" class="select" disabled>
              <option value="Commuter">Commuter</option>
              <option value="Faculty">Faculty/Staff</option>
              <option value="All">All Parking Garage Zone</option>
            </select>
            <div class="hint">Drivers must have a parking permit.</div>
          </div>
        </div>

        <div class="status" id="status"></div>
        <div class="actions">
          <a href="/dashboard" class="btn ghost" id="cancelBtn">Cancel</a>
          <button type="submit" class="btn primary" id="saveBtn">Save Changes</button>
        </div>
      </form>
    </Card>
  </div>
</Layout>

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    background: radial-gradient(1200px 800px at 10% -10%, #13214a 0%, var(--bg) 40%, #090e1d 100%);
    color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  a{color:var(--primary); text-underline-offset:3px}
  .shell{max-width:900px; margin:0 auto; padding:24px}

  header.nav{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:22px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:36px;height:36px;border-radius:10px;display:block;box-shadow:0 8px 20px rgba(90,162,255,.35)}
  .brand .title{font-weight:750;letter-spacing:-.02em}

  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .card .hdr{padding:16px 18px; border-bottom:1px solid var(--border-2); font-weight:800; letter-spacing:-.01em}
  .card .body{padding:18px; display:grid; gap:14px}

  .field{display:grid; gap:8px}
  .label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em}
  .input, .select{
    width:100%;
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    color:var(--text);
    border:1px solid rgba(255,255,255,.28);
    border-radius:12px;
    padding:12px 14px;
    outline:none;
  }

  /* Custom styling for select dropdowns */
  .select {
    appearance: none;
    padding-right: 36px;
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24'><path fill='%23ffffff' d='M7 10l5 5 5-5z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 12px center;
  }

  /* Style the options in the dropdown */
  .select option {
    background-color: var(--panel);
    color: var(--text);
    padding: 8px;
  }

  .input:focus, .select:focus{
    border-color:var(--primary);
    box-shadow:0 0 0 6px var(--ring);
  }

  .hint{font-size:12px; color:var(--muted)}

  .actions{display:flex; gap:10px; justify-content:flex-end; padding:14px 18px; border-top:1px solid var(--border-2)}
  .btn{
    appearance:none; border:1px solid var(--border-2); background:rgba(255,255,255,.06);
    color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;
    transition:transform .06s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{ background:linear-gradient(180deg,var(--primary),var(--primary-600)); color:#05122a; border-color:rgba(90,162,255,.6) }
  .btn.ghost{ background:transparent }

  .status{padding:0 18px 14px 18px; display:none}
  .status.show{display:block}
  .status.ok{color:#bbf7d0}
  .status.err{color:#fecaca}

  @media (min-width: 720px){
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:14px }
  }

  /* visually disable hidden permit field area to avoid layout jump */
  .hidden{ display:none }
</style>

<script>
  // Find all the elements within the page
  const form = document.getElementById("profileForm") as HTMLFormElement;
  const statusEl = document.getElementById("status") as HTMLDivElement;
  const nameEl = document.getElementById("name") as HTMLInputElement;
  const userEl = document.getElementById("username") as HTMLInputElement;
  const typeEl = document.getElementById("type") as HTMLSelectElement;
  const permitWrap = document.getElementById("permitField") as HTMLDivElement;
  const permitEl = document.getElementById("permit") as HTMLSelectElement;

  // Declare some helper functions
  function showStatus(msg?: string, kind: string = "ok"){
    // Sets the status element and its message. Pass undefined to hide
    statusEl.textContent = msg || "";
    statusEl.className = (msg ? `status show ${kind}` : "status");

    if(kind === "ok"){
      // OK statuses should clear after 2 seconds
      setTimeout(() => statusEl.className = 'status', 2000);
    }
  }

  function setPermitEnabled(enabled: boolean){
    // Sets the permit option enabled or disabled. This is because cyclists should not be able to set a permit type
    permitWrap.classList.toggle("hidden", !enabled);
    permitEl.disabled = !enabled;

    if(!enabled){
      // Simple book keeping to keep the permit type empty if its a cyclist.
      permitEl.value = '';
    }
  }

  async function loadProfile(){
    // Runs the fetch to obtain profile data and populates it into the respective fields
    try {
      const res = await fetch("/api/user/profile", {
        credentials: "include"
      });

      if(!res.ok)
        throw new Error(await res.text());

      // Convert response body to json, as the backend payload sends a json
      const p = await res.json(); // Expected: { name, username, type: 'Driver'|'Cyclist', permit?: string|null }

      if(!p)
        throw new Error("Invalid payload from server");

      // Populate fields if they exist
      nameEl.value = p.name ?? "";
      userEl.value = p.username ?? "";
      typeEl.value = (p.userType === "CYCLIST") ? "Cyclist" : "Driver";

      // Check if the permit section should be opened up
      const isDriver = typeEl.value === "Driver";
      setPermitEnabled(isDriver);

      if(isDriver){
        // Convert the permit payload type to a human readable value
        if(p.permit == "COMMUTER"){
          permitEl.value = "Commuter";
        } else if(p.permit == "FACULTY"){
          permitEl.value = "Faculty";
        } else if(p.permit == "ALL"){
          permitEl.value = "All";
        }
      }
    } catch(err) {
      // Error out
      setPermitEnabled(typeEl.value === 'Driver'); // Default UI state
      showStatus("Could not load profile.", "err");
      console.error(err);
    }
  }

  // Populate event listeners
  typeEl.addEventListener("change", () => {
    // This function keeps the permit enabled dependant on the type of driver/cyclist
    const isDriver = typeEl.value === "Driver";
    setPermitEnabled(isDriver);

    if(isDriver && !permitEl.value){
      // Default to Commuter if none selected
      permitEl.value = "Commuter";
    }
  });

  form.addEventListener("submit", async (event) => {
    // Save profile when the form is submitted
    event.preventDefault(); // Stop the form from trying to redirect
    const isDriver = typeEl.value === "Driver";
    
    // Basic client validation
    if(!nameEl.value.trim() || !userEl.value.trim()){
      showStatus("Name and username are required.", "err");
      return;
    }
    
    if(isDriver && !permitEl.value){
      showStatus("Please select a permit for Driver type.", "err");
      return;
    }
    
    // Construct a payload to send to the server
    const payload = {
      name: nameEl.value.trim(),
      username: userEl.value.trim(),
      type: typeEl.value,
      permit: isDriver ? permitEl.value : null
    };

    // Attempt sending the payload to the server to update the user
    try {
      const res = await fetch("/api/user/profile", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        // Error out if the result was not okay
        const msg = await res.text();
        throw new Error(msg || "Failed to save");
      }

      showStatus("Profile updated successfully!", "ok");
    } catch(err) {
      showStatus(`Save failed: ${err}`, "err");
    }
  });

  // Kick off initial load
  loadProfile();
</script>