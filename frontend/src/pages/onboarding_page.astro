---
import Card from "src/components/Card.astro";
import NavBar from "src/components/NavBar.astro";
import BaseLayout from "src/layouts/BaseLayout.astro";

const title = "Finish setting up your profile";
---

<BaseLayout title={title}>
	<NavBar />
	<main class="flex-center-content">
		<Card title="Onboarding">
			<form id="onboardingForm" class="d-grid gap-3" novalidate>
				<!-- Username -->
				<div class="p-2 border rounded form-group">
					<label for="username" class="form-label">Username</label>
					<input
						id="username"
						name="username"
						class="form-control"
						type="text"
						placeholder="Choose a username"
						required
					/>
					<small class="text-muted">This will be your public username (no spaces).</small>
				</div>

				<!-- Account Type -->
				<div class="p-2 border rounded form-group">
					<label id="acctTypeLabel" class="form-label d-block mb-2">Account Type</label>
					<div class="btn-group btn-group-toggle" role="group" aria-labelledby="acctTypeLabel">
						<input type="radio" class="btn-check" name="accountType" id="accountTypeDriver" value="Driver" checked />
						<label class="btn btn-outline-secondary btn-sm" for="accountTypeDriver">Driver</label>

						<input type="radio" class="btn-check" name="accountType" id="accountTypeCyclist" value="Cyclist" />
						<label class="btn btn-outline-secondary btn-sm" for="accountTypeCyclist">Cyclist</label>
					</div>
				</div>

				<!-- Parking permit (only for Drivers) -->
				<div id="permitGroup" class="border p-2 rounded form-group">
					<label for="permit" class="form-label">Parking Permit</label>
					<select id="permit" name="permit" class="form-select" required>
						<option value="" disabled selected>Select your permit…</option>
						<option value="COMMUTER">Commuter</option>
						<option value="EMPLOYEE">Employee</option>
						<option value="GARAGE">Garage Zone</option>
					</select>
					<small class="text-muted">Required for Drivers. Not needed for Cyclists.</small>
				</div>

				<div id="msg" class="status" aria-live="polite"></div>
				<button type="button" class="btn btn-outline-secondary" id="SkipForNow">Skip for now</button>
				<button type="submit" class="btn btn-primary" id="submitBtn">Save & Continue</button>
			</form>
		</Card>
		<div id="toast" class="toast" role="status" aria-live="polite">Profile saved. You’re all set!</div>
	</main>
</BaseLayout>

<script type="module">
	const form = document.getElementById("onboardingForm");
	const permitGroup = document.getElementById("permitGroup");
	const permitSelect = document.getElementById("permit");
	const usernameEl = document.getElementById("username");
	const msg = document.getElementById("msg");
	const toast = document.getElementById("toast");
	const submitBtn = document.getElementById("submitBtn");

	// Helper
	const getAccountType = () => document.querySelector('input[name="accountType"]:checked')?.value;

	// Toggle permit visibility
	function updateAccountTypeUI() {
		const isDriver = getAccountType() === "Driver";
		permitGroup.classList.toggle("hidden", !isDriver);
		permitSelect.required = isDriver;
		if (!isDriver) permitSelect.value = "";
		msg.textContent = isDriver
			? "Drivers must select a parking permit."
			: "Cyclists don’t need a parking permit.";
	}
	document.querySelectorAll('input[name="accountType"]').forEach(r => r.addEventListener("change", updateAccountTypeUI));

	// Validation
	function validate() {
		const problems = [];
		const acct = getAccountType();
		if (!usernameEl.value.trim() || /\s/.test(usernameEl.value)) problems.push("Please choose a username (no spaces).");
		if (acct === "Driver" && !permitSelect.value) problems.push("Please choose a parking permit.");
		msg.textContent = problems.join(" ");
		return problems.length === 0;
	}

	// Submit
	form.addEventListener("submit", async e => {
		e.preventDefault();
		if (!validate()) return;
		submitBtn.disabled = true;

		const payload = {
			accountType: getAccountType(),
			permit: getAccountType() === "Driver" ? permitSelect.value : null,
			username: usernameEl.value.trim(),
		};

		try {
			const email = localStorage.getItem("pendingEmail");
			console.log(email);
			const res = await fetch("/api/user/onboarding", {
			 	method: "POST",
        		headers: { "Content-Type": "application/json" },
        		body: JSON.stringify({ email: email , payload: payload })
      		});

			if (!res.ok) throw new Error(`Save failed: ${res.status} ${res.statusText}`);

			toast.classList.add("show");
			msg.textContent = "Saved! Redirecting… if you have not verified email will bring you back to login";
			localStorage.removeItem("pendingEmail");
			setTimeout(() => (window.location.href = "/dashboard"), 900);
		} catch (err) {
			console.error(err);
			msg.textContent = "Something went wrong saving your profile. Please try again.";
		} finally {
			submitBtn.disabled = false;
		}
	});

	// Skip-for-now
	document.getElementById("SkipForNow").addEventListener("click", async () => {
	toast.textContent = "Preference saved. Redirecting…";
	localStorage.removeItem("pendingEmail");
			toast.classList.add("show");
			window.location.href = "/";
	});
</script>