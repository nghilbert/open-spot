---
import BaseLayout from "src/layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Filter from "../components/FilterComponent.astro";
import ColorScore from "../components/ColorScore.astro";
import "../assets/styles/dashboard.css";

// Force the server to regenerate the page every request, rather than at `npm run build`.
export const prerender = false;
//request user session and makes sure it is vaild and active
const res = await fetch(`${Astro.url.origin}/api/user/profile`, {
	headers: {
		Cookie: `session=${Astro.cookies.get("session")?.value}`,
	},
});

//redirects user before the page load to the login page if they are not logged in
if (!res.ok) {
	return new Response(null, {
		status: 302,
		headers: {
			Location: "/",
		},
	});
}
const user = await res.json();

// Title of the page, to be shown on the internet tab and at the top of the page
const title = "Dashboard";
//the list of buttons to be given to the header
const buttonList = [{ label: "Profile", href: "/profile", class: "btn btn-outline-light" }];
//if the user is an Admin the will see the admin dashboard button
if (user.role === "ADMIN") {
	buttonList.push({ label: "Admin", href: "/admin", class: "btn btn-outline-light" });
}
//Temp list for the lots, needs to be remove once pulling from database
const lots = [
	{
		id: 1,
		name: "South Garage",
		address: "123 Oak St",
		kind: "Parking",
		permitRequired: "Commuter",
		availability: { used: 11, total: 50 },
	},
	{
		id: 2,
		name: "Library Deck",
		address: "45 Campus Way",
		kind: "Parking",
		permitRequired: "All Parking Garage Zone",
		availability: { used: 50, total: 50 },
	},
	{
		id: 3,
		name: "Rec Center Racks",
		address: "200 Fitness Dr",
		kind: "Bike",
		permitRequired: null,
		availability: { used: 12, total: 60 },
	},
	{
		id: 4,
		name: "North Lot",
		address: "800 Maple Ave",
		kind: "Parking",
		permitRequired: "Faculty/Staff",
		availability: { used: 22, total: 40 },
	},
	{
		id: 5,
		name: "Arts Quad Racks",
		address: "10 Studio Ln",
		kind: "Bike",
		permitRequired: null,
		availability: { used: 2, total: 40 },
	},
];
//Available Filter options
const availOptions = [
	{ label: "All", value: "" },
	{ label: "Available Spots", value: "available" },
	{ label: "Full", value: "full" },
];
//Type Filter options
const typeOptions = [
	{ label: "Any", value: "" },
	{ label: "Parking", value: "Parking" },
	{ label: "Bike Rack", value: "Bike" },
];
//Permit Filter options
const permitOptions = [
	{ label: "Any", value: "" },
	{ label: "None", value: "None" },
	{ label: "Commuter", value: "Commuter" },
	{ label: "Faculty/Staff", value: "Faculty/Staff" },
	{ label: "All Parking Garage Zone", value: "All Parking Garage Zone" },
];

const clamp = (n: number, a: number, b: number): number => Math.max(a, Math.min(b, n));
const pct = (used: number, total: number): number => (total > 0 ? clamp(Math.round((used / total) * 100), 0, 100) : 0);
const occ = (p: number): "green" | "yellow" | "red" => (p >= 100 ? "red" : p >= 50 ? "yellow" : "green");
const permitLabel = (kind: "Parking" | "Bike", permit: string | null): string =>
	kind === "Parking" ? permit || "—" : "None";

const occStyles = {
	green: { bg: "#11341e", br: "#2fb36a", fg: "#eafff1" },
	yellow: { bg: "#3b2a0e", br: "#f5a623", fg: "#fff4cf" },
	red: { bg: "#3a1515", br: "#f06464", fg: "#ffe3e3" },
};
---

<BaseLayout title={`Open Spot — ${title}`}>
	<div class="container py-4">
		<NavBar title={title} buttonList={buttonList} />

		<!-- Filters -->
		<section
			class="card shadow-lg rounded-4 border"
			style="background:linear-gradient(180deg,#111936,#0e1530); border-color:rgba(255,255,255,.10);"
		>
			<div class="p-3 d-grid gap-3">
				<Filter
					searchLabel="Search"
					availOptions={availOptions}
					typeOptions={typeOptions}
					permitOptions={permitOptions}
					onSubmit="#"
				/>
				<ColorScore />
			</div>
		</section>

		<!-- List -->
		<section class="d-grid gap-4 mt-4" id="list">
			{
				lots.map((lot) => {
					const used = Number(lot.availability?.used ?? 0);
					const total = Number(lot.availability?.total ?? 0);
					const p = pct(used, total);
					const state = occ(p);
					const style = occStyles[state];
					const occText = total > 0 ? `${used}/${total} spots full` : "—";
					const typeText = lot.kind === "Parking" ? "Parking" : "Bike Rack";
					const permitTxt = lot.kind === "Parking" ? lot.permitRequired : "None";
					const isAvailable = total > used ? "true" : "false";

					return (
						<article
							class="card p-3 rounded-4 border lotCard"
							data-name={lot.name}
							data-address={lot.address}
							data-kind={lot.kind}
							data-permit={permitTxt}
							data-available={isAvailable}
							style={`background:${style.bg}; color:${style.fg}; border-color:${style.br};`}
						>
							<div class="d-grid gap-3" style="grid-template-columns:1fr auto;">
								<div class="d-grid gap-1">
									<div class="fw-bold lh-sm">{lot.name}</div>
									<div class="small text-opacity-75">{lot.address}</div>
									<div class="d-flex flex-wrap gap-2">
										<span class="badge rounded-pill border" style="background:rgba(255,255,255,.08);">
											{typeText}
										</span>
										<span class="badge rounded-pill border" style="background:rgba(255,255,255,.08);">
											Permit: {permitTxt}
										</span>
										<span class="badge rounded-pill border" style="background:rgba(255,255,255,.08);">
											{occText}
										</span>
									</div>
								</div>
								<div class="text-end d-grid gap-2" style="align-items: start;">
									<div
										class="fw-bold fs-5 px-3 py-2 rounded-pill border"
										style="background:rgba(0,0,0,.25); border-color:rgba(255,255,255,.28);"
									>
										{p}%
									</div>
									{user.role === "ADMIN" && (
										<button
											class="editBtn"
											data-lot-id={lot.id}
											data-lot-name={lot.name}
											data-lot-address={lot.address}
											data-lot-kind={lot.kind}
											data-lot-permit={lot.permitRequired || "None"}
											data-lot-used={Number(lot.availability?.used ?? 0)}
											data-lot-total={Number(lot.availability?.total ?? 0)}
											title="Edit location"
											aria-label="Edit location"
										>
											<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
												<path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor" />
												<path d="M20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor" />
											</svg>
										</button>
									)}
								</div>
							</div>
							<div class="progress rounded-pill bg-dark-subtle mt-3" style="height:8px;">
								<div class="progress-bar" role="progressbar" style={`width:${p}%; background:rgba(255,255,255,.92);`} />
							</div>
						</article>
					);
				})
			}
		</section>

		<div class="text-center py-4 text-muted" id="empty" style="display:none">No locations match your filters.</div>
	</div>

	<!-- Edit Modal -->
	<div id="editModal" class="editModal">
		<div class="editModal-content">
			<div class="editModal-header">
				<h2>Edit Location</h2>
				<button class="editModal-close" aria-label="Close modal">&times;</button>
			</div>
			<form id="editForm">
				<div class="editModal-body">
					<div class="editModal-field">
						<label for="modalName">Location Name</label>
						<input type="text" id="modalName" name="name" required />
					</div>
					<div class="editModal-field">
						<label for="modalAddress">Address</label>
						<input type="text" id="modalAddress" name="address" required />
					</div>
					<div class="editModal-field">
						<label for="modalKind">Type</label>
						<select id="modalKind" name="kind" required>
							<option value="Parking">Parking</option>
							<option value="Bike">Bike Rack</option>
						</select>
					</div>
					<div class="editModal-field">
						<label for="modalPermit">Permit Required</label>
						<select id="modalPermit" name="permit">
							<option value="None">None</option>
							<option value="Commuter">Commuter</option>
							<option value="Faculty/Staff">Faculty/Staff</option>
							<option value="All Parking Garage Zone">All Parking Garage Zone</option>
						</select>
					</div>
					<div class="editModal-field">
						<label for="modalUsed">Spots Used</label>
						<input type="number" id="modalUsed" name="used" min="0" required />
					</div>
					<div class="editModal-field">
						<label for="modalTotal">Total Spots</label>
						<input type="number" id="modalTotal" name="total" min="0" required />
					</div>
				</div>
				<div class="editModal-footer">
					<button type="button" class="editModal-btn" id="modalCancel">Cancel</button>
					<button type="submit" class="editModal-btn primary">Save Changes</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// Edit modal functionality
		const editModal = document.getElementById('editModal');
		const editForm = document.getElementById('editForm');
		const modalCloseBtn = document.querySelector('.editModal-close');
		const modalCancelBtn = document.getElementById('modalCancel');
		let currentLotId = null;

		function openEditModal(btn) {
			currentLotId = btn.dataset.lotId;
			document.getElementById('modalName').value = btn.dataset.lotName || '';
			document.getElementById('modalAddress').value = btn.dataset.lotAddress || '';
			document.getElementById('modalKind').value = btn.dataset.lotKind || 'Parking';
			document.getElementById('modalPermit').value = btn.dataset.lotPermit || 'None';
			document.getElementById('modalUsed').value = btn.dataset.lotUsed || 0;
			document.getElementById('modalTotal').value = btn.dataset.lotTotal || 0;
			editModal.classList.add('show');
		}

		function closeEditModal() {
			editModal.classList.remove('show');
			currentLotId = null;
		}

		// Event listeners for modal
		document.querySelectorAll('.editBtn').forEach(btn => {
			btn.addEventListener('click', () => openEditModal(btn));
		});

		modalCloseBtn.addEventListener('click', closeEditModal);
		modalCancelBtn.addEventListener('click', closeEditModal);

		// Close modal when clicking outside
		editModal.addEventListener('click', (e) => {
			if (e.target === editModal) closeEditModal();
		});

		// Handle form submission
		editForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData(editForm);
			const data = Object.fromEntries(formData);
			
			try {
				const res = await fetch(`/api/locations/${currentLotId}`, {
					method: 'PATCH',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						name: data.name,
						address: data.address,
						kind: data.kind,
						permitRequired: data.permit !== 'None' ? data.permit : null,
						availability: {
							used: parseInt(data.used),
							total: parseInt(data.total)
						}
					}),
					credentials: 'include'
				});
				if (res.ok) {
					alert('Location updated successfully!');
					closeEditModal();
					location.reload();
				} else {
					alert('Error updating location. Please try again.');
				}
			} catch (err) {
				console.error(err);
				alert('An error occurred while updating the location.');
			}
		});

		$(function () {
			function applyFilters() {
				const q = ($("#search").val() ?? "").toString().toLowerCase().trim();
				const avail = $("#avail").val();
				const type = $("#type").val();
				const permit = ($("#permit").val() ?? "").toString().toLowerCase();

				let visible = 0;

				$(".lotCard").each(function () {
					const $card = $(this);
					const name = ($card.data("name") || "").toLowerCase();
					const address = ($card.data("address") || "").toLowerCase();
					const kind = $card.data("kind");
					const cardPermit = ($card.data("permit") || "").toLowerCase();
					const isAvailable = $card.data("available") === true || $card.data("available") === "true";

					const matchText = !q || name.includes(q) || address.includes(q);
					const matchType = !type || kind === type;
					const matchPermit = !permit || cardPermit === permit;
					const matchAvail = !avail || (avail === "available" && isAvailable) || (avail === "full" && !isAvailable);

					const show = matchText && matchType && matchPermit && matchAvail;
					$card.toggle(show);
					if (show) visible++;
				});

				$("#empty").toggle(visible === 0);
			}

			$("#search, #avail, #type, #permit").on("input change", applyFilters);
			$("#resetFilters").on("click", function (e) {
				e.preventDefault();
				$("#search, #avail, #type, #permit").val("");
				applyFilters();
			});

			applyFilters();
		});
	</script>
</BaseLayout>
