---
import BaseLayout from "src/layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Filter from "../components/FilterComponent.astro";
import ColorScore from "../components/ColorScore.astro";
import "../assets/styles/dashboard.css";
import LocationCard from "src/components/locationCard.astro";
import EditModel from "../components/EditModel.astro";

// Force the server to regenerate the page every request, rather than at `npm run build`.
export const prerender = false;
//request user session and makes sure it is vaild and active
var res = await fetch(`${Astro.url.origin}/api/user/profile`, {
	headers: {
		Cookie: `session=${Astro.cookies.get("session")?.value}`,
	},
});

//redirects user before the page load to the login page if they are not logged in
if (!res.ok) {
	return new Response(null, {
		status: 302,
		headers: {
			Location: "/",
		},
	});
}
const user = await res.json();

res = await fetch(`${Astro.url.origin}/api/location/getAll`, {
	headers: {
		Cookie: `session=${Astro.cookies.get("session")?.value}`,
	},
});

var lots = await res.json();

if (!res.ok) {
	lots = [];
}

// Title of the page, to be shown on the internet tab and at the top of the page
const title = "Dashboard";
//the list of buttons to be given to the header
const buttonList = [{ label: "Profile", href: "/profile", class: "btn btn-outline-light" }];
//if the user is an Admin the will see the admin dashboard button
if (user.role === "ADMIN") {
	buttonList.push({ label: "Admin", href: "/admin", class: "btn btn-outline-light" });
}

//Available Filter options
const availOptions = [
	{ label: "All", value: "" },
	{ label: "Available Spots", value: "available" },
	{ label: "Full", value: "full" },
];
//Type Filter options
const typeOptions = [
	{ label: "Any", value: "" },
	{ label: "Parking", value: "PARKING_LOT" },
	{ label: "Bike Rack", value: "BIKE_RACK" },
];
//Permit Filter options
const permitOptions = [
	{ label: "Any", value: "" },
	{ label: "None", value: "NONE" },
	{ label: "Commuter", value: "COMMUTER" },
	{ label: "Employee", value: "EMPLOYEE" },
	{ label: "Garage Zone", value: "GARAGE" },
];

const clamp = (n: number, a: number, b: number): number => Math.max(a, Math.min(b, n));
const pct = (used: number, total: number): number => (total > 0 ? clamp(Math.round((used / total) * 100), 0, 100) : 0);
const occ = (p: number): "green" | "yellow" | "red" => (p >= 100 ? "red" : p >= 50 ? "yellow" : "green");
const permitLabel = (kind: "Parking" | "Bike", permit: string | null): string =>
	kind === "Parking" ? permit || "—" : "None";

const occStyles = {
	green: { bg: "#11341e", br: "#2fb36a", fg: "#eafff1" },
	yellow: { bg: "#3b2a0e", br: "#f5a623", fg: "#fff4cf" },
	red: { bg: "#3a1515", br: "#f06464", fg: "#ffe3e3" },
};
---

<BaseLayout title={`Open Spot — ${title}`}>
	<div class="container py-4">
		<NavBar title={title} buttonList={buttonList} />

		<!-- Filters -->
		<section class="card shadow-lg rounded-4 border">
			<div class="p-3 d-grid gap-3">
				<Filter
					searchLabel="Search"
					availOptions={availOptions}
					typeOptions={typeOptions}
					permitOptions={permitOptions}
					onSubmit="#"
				/>
				<ColorScore />
			</div>
		</section>

		<!-- List -->
		<LocationCard user={user} lots={lots} pct={pct} occ={occ} occStyles={occStyles} />

		<!-- Edit Modal -->
		<EditModel />

		<!-- Stay at Location Modal -->
		<div id="stayModal" class="stayModal">
			<div class="stayModal-content">
				<h2 class="stayModal-title">Stay at this location?</h2>
				<div class="stayModal-location" id="stayLocationText"></div>
				<div class="stayModal-buttons">
					<button type="button" class="stayModal-btn secondary" id="stayNoBtn">No</button>
					<button type="button" class="stayModal-btn primary" id="stayYesBtn">Yes</button>
				</div>
			</div>
		</div>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			// Stay at location modal functionality
			const stayModal = document.getElementById('stayModal');
			const stayLocationText = document.getElementById('stayLocationText');
			const stayYesBtn = document.getElementById('stayYesBtn');
			const stayNoBtn = document.getElementById('stayNoBtn');
			let currentSelectedLot = null;

			function openStayModal(lotCard) {
				const name = lotCard.dataset.name || 'Unknown Location';
				const address = lotCard.dataset.address || '';
				currentSelectedLot = lotCard;
				stayLocationText.textContent = name + (address ? '\n' + address : '');
				stayModal.classList.add('show');
			}

			function closeStayModal() {
				stayModal.classList.remove('show');
				currentSelectedLot = null;
			}

			// Attach click handlers to location cards
			document.querySelectorAll('.lotCard').forEach(card => {
				// Only trigger on the card itself, not on edit button or nav icon
				card.addEventListener('click', (e) => {
					// Don't open modal if clicking edit button or nav icon
					if (e.target.closest('.editBtn') || e.target.closest('.navIcon')) {
						return;
					}
					openStayModal(card);
				});
			});

			stayYesBtn.addEventListener('click', () => {
				console.log('User confirmed staying at location:', currentSelectedLot?.dataset.name);
				// TODO: Call backend API to record that user is staying at this location
				closeStayModal();
			});

			stayNoBtn.addEventListener('click', () => {
				closeStayModal();
			});

			// Close modal when clicking outside
			stayModal.addEventListener('click', (e) => {
				if (e.target === stayModal) closeStayModal();
			});

			const editModal = document.getElementById("editModal");
			var locationID = "";
			//populates the form feilds with data from the element(location) that was clicked on
			if (editModal) {
				editModal.addEventListener("show.bs.modal", (event: any) => {
					const btn = event.relatedTarget as HTMLElement;
					locationID = btn.dataset.lotId ?? "";

					(document.getElementById("modalName") as HTMLInputElement).value = btn.dataset.lotName || "";

					(document.getElementById("modalNumber") as HTMLInputElement).value = btn.dataset.lotNumber || "";

					(document.getElementById("modalStreet") as HTMLInputElement).value = btn.dataset.lotStreet || "";

					(document.getElementById("modalCity") as HTMLInputElement).value = btn.dataset.lotCity || "";

					(document.getElementById("modalState") as HTMLInputElement).value = btn.dataset.lotState || "";

					(document.getElementById("modalZip") as HTMLInputElement).value = btn.dataset.lotZip || "";

					(document.getElementById("modalKind") as HTMLSelectElement).value = btn.dataset.lotKind || "Parking";

					(document.getElementById("modalPermit") as HTMLSelectElement).value = btn.dataset.lotPermit || "None";

					(document.getElementById("modalUsed") as HTMLInputElement).value = btn.dataset.lotAvailable || "0";

					(document.getElementById("modalTotal") as HTMLInputElement).value = btn.dataset.lotTotal || "0";

					(document.getElementById("modalTimeLimitSecs") as HTMLInputElement).value =
						btn.dataset.timeLimitSecs || "null";
				});
			}

			//form on document
			const form = document.getElementById("editForm") as HTMLFormElement;
			const msg = document.getElementById("msg") as HTMLFormElement;
			//when the form is submitted, make update call to backend
			form.addEventListener("submit", async (e) => {
				e.preventDefault();
				const updates = {
					modelLocationID: locationID,
					modalName: (document.getElementById("modalStreet") as HTMLInputElement).value,
					modelNumber: (document.getElementById("modalNumber") as HTMLInputElement).value,
					modelStreet: (document.getElementById("modalStreet") as HTMLInputElement).value,
					modelCity: (document.getElementById("modalCity") as HTMLInputElement).value,
					modelState: (document.getElementById("modalState") as HTMLInputElement).value,
					modelZip: (document.getElementById("modalZip") as HTMLInputElement).value,
					modelType: (document.getElementById("modalKind") as HTMLSelectElement).value,
					modelPermit: (document.getElementById("modalPermit") as HTMLSelectElement).value,
					modelUsed: (document.getElementById("modalUsed") as HTMLInputElement).value,
					modelTotal: (document.getElementById("modalTotal") as HTMLInputElement).value,
					modelTimeLimitSecs: (document.getElementById("modalTimeLimitSecs") as HTMLInputElement).value,
				};

				try {
					const updateCall = await fetch(`/api/location/update`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ data: updates }),
						credentials: "include",
					});

					if (!updateCall.ok) throw new Error(`Save failed: ${updateCall.status} ${updateCall.statusText}`);

					window.location.reload();
				} catch (err) {
					console.error(err);
					msg.textContent = "Something went wrong saving your changes. Please try again.";
				}
			});

			$(function () {
				function applyFilters() {
					const q = ($("#search").val() ?? "").toString().toLowerCase().trim();
					const avail = $("#avail").val();
					const type = $("#type").val();
					const permit = ($("#permit").val() ?? "").toString().toLowerCase();

					let visible = 0;

					$(".lotCard").each(function () {
						const $card = $(this);
						const name = ($card.data("name") || "").toLowerCase();
						const address = ($card.data("address") || "").toLowerCase();
						const kind = $card.data("kind");
						const cardPermit = ($card.data("permit") || "").toLowerCase();
						const isAvailable = $card.data("available") === true || $card.data("available") === "true";

						const matchText = !q || name.includes(q) || address.includes(q);
						const matchType = !type || kind === type;
						const matchPermit = !permit || cardPermit === permit;
						const matchAvail = !avail || (avail === "available" && isAvailable) || (avail === "full" && !isAvailable);

						const show = matchText && matchType && matchPermit && matchAvail;
						$card.toggle(show);
						if (show) visible++;
					});

					$("#empty").toggle(visible === 0);
				}

				$("#search, #avail, #type, #permit").on("input change", applyFilters);
				$("#resetFilters").on("click", function (e) {
					e.preventDefault();
					$("#search, #avail, #type, #permit").val("");
					applyFilters();
				});

				applyFilters();
			});
		</script>
	</div></BaseLayout
>
