---
import BaseLayout from "src/layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Filter from "../components/FilterComponent.astro";
import Card from "../components/Card.astro";
import Modal from "../components/Modal.astro";
import ColorScore from "../components/ColorScore.astro";
import "../assets/styles/dashboard.css";
import LocationCard from "src/components/locationCard.astro";
import EditModel from "../components/EditModel.astro";
import type { User } from "@Prisma/client";
// Force the server to regenerate the page every request, rather than at `npm run build`.
export const prerender = false;
//request user session and makes sure it is vaild and active
var res = await fetch(`${Astro.url.origin}/api/user/profile`, {
	headers: {
		Cookie: `session=${Astro.cookies.get("session")?.value}`,
	},
});

//redirects user before the page load to the login page if they are not logged in
if (!res.ok) {
	return new Response(null, {
		status: 302,
		headers: {
			Location: "/",
		},
	});
}
const user = (await res.json()) as User;

res = await fetch(`${Astro.url.origin}/api/location/getAll`, {
	headers: {
		Cookie: `session=${Astro.cookies.get("session")?.value}`,
	},
});

var locations = await res.json();
if (!res.ok) {
	locations = [];
}

// Title of the page, to be shown on the internet tab and at the top of the page
const title = "Dashboard";
//the list of buttons to be given to the header
const buttonList = [{ label: "Profile", href: "/profile", class: "btn btn-outline-light" }];
//if the user is an Admin the will see the admin dashboard button
if (user.role === "ADMIN") {
	buttonList.push({ label: "Admin", href: "/admin", class: "btn btn-outline-light" });
}

//Available Filter options
const availOptions = [
	{ label: "All", value: "" },
	{ label: "Available Spots", value: "available" },
	{ label: "Full", value: "full" },
];
//Type Filter options
const typeOptions = [
	{ label: "Any", value: "" },
	{ label: "Parking", value: "PARKING_LOT" },
	{ label: "Bike Rack", value: "BIKE_RACK" },
];
//Permit Filter options
const permitOptions = [
	{ label: "Any", value: "" },
	{ label: "None", value: "NONE" },
	{ label: "Commuter", value: "COMMUTER" },
	{ label: "Employee", value: "EMPLOYEE" },
	{ label: "Garage Zone", value: "GARAGE" },
];

const clamp = (n: number, a: number, b: number): number => Math.max(a, Math.min(b, n));
const pct = (used: number, total: number): number => (total > 0 ? clamp(Math.round((used / total) * 100), 0, 100) : 0);
const occ = (p: number): "green" | "yellow" | "red" => (p >= 100 ? "red" : p >= 50 ? "yellow" : "green");
const permitLabel = (kind: "Parking" | "Bike", permit: string | null): string =>
	kind === "Parking" ? permit || "—" : "None";

const occStyles = {
	green: { bg: "#11341e", br: "#2fb36a", fg: "#eafff1" },
	yellow: { bg: "#3b2a0e", br: "#f5a623", fg: "#fff4cf" },
	red: { bg: "#3a1515", br: "#f06464", fg: "#ffe3e3" },
};
---

<BaseLayout title={`Open Spot — ${title}`}>
	<div class="container py-4">
		<NavBar title={title} buttonList={buttonList} />

		<!-- Timer Display -->
		<div class="alert alert-info d-flex justify-content-between align-items-center" id="timerDisplay">
			<span>Not Occupying Any Spots</span>
			<button type="button" class="btn btn-sm btn-danger" id="leaveBtn">Leave</button>
		</div>

		<!-- Filters -->
		<Card>
			<div class="p-3 d-grid gap-3">
				<Filter
					searchLabel="Search"
					availOptions={availOptions}
					typeOptions={typeOptions}
					permitOptions={permitOptions}
					onSubmit="#"
				/>
				<ColorScore />
			</div>
			{
				user.role == "ADMIN" && (
					<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLocationModal">
						Add a Location
					</button>
				)
			}
		</Card>

		<!-- List -->
		<LocationCard user={user} locations={locations} pct={pct} occ={occ} occStyles={occStyles} />

		<!-- Edit Modal -->
		<EditModel />

		<Modal title="Add a Location" id="addLocationModal">
			<form id="addLocationForm" class="d-grid gap-3">
				<label>Name:</label>
				<input name="name" class="form-control" placeholder="Name" />

				<label>Location Type:</label>
				<select name="locationType" class="form-select" required>
					<option value="NONE">None</option>
					<option value="PARKING_LOT">Parking Lot</option>
					<option value="BIKE_RACK">Bike Rack</option>
				</select>

				<label>Spot Capacity:</label>
				<input name="spotCapacity" type="number" class="form-control" placeholder="e.g. 200" required />

				<label>Time Limit (seconds):</label>
				<input name="timeLimitSecs" type="number" class="form-control" placeholder="null" />

				<!-- Address Fields -->
				<br /><h4>Address</h4>
				<input name="number" type="number" class="form-control" placeholder="Street Number" required />
				<input name="street" class="form-control" placeholder="Street" required />
				<input name="city" class="form-control" placeholder="City" required />
				<input name="state" class="form-control" placeholder="State" required />
				<input name="zip" type="number" class="form-control" placeholder="Zip" required />

				<button type="submit" class="btn btn-primary">Submit</button>
			</form>
			<div id="addLocationMsg" class="mt-3 text-center"></div>
		</Modal>

		<!-- Stay at Location Modal -->
		<div class="modal fade" id="stayModal" tabindex="-1" aria-labelledby="stayModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content bg-dark text-white">
					<div class="modal-header border-0">
						<h5 class="modal-title" id="stayModalLabel">Stay at this location?</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div id="stayLocationText" class="small text-secondary"></div>
					</div>
					<div class="modal-footer justify-content-center border-0">
						<button type="button" class="btn btn-danger" id="stayNoBtn" data-bs-dismiss="modal">No</button>
						<button type="button" class="btn btn-success" id="stayYesBtn" data-bs-dismiss="modal">Yes</button>
					</div>
				</div>
			</div>
		</div>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			import type { CreateTimerRequest } from "@openspot/shared";
			import type { Prisma, Permit, Type } from "@prisma/client";
			type LocationAddress = Prisma.LocationGetPayload<{
				include: {
					address: {
						select: {
							number: true;
							street: true;
							city: true;
							state: true;
							zip: true;
						};
					};
				};
			}>;
			type UpdateLocationInput = Omit<Prisma.LocationUpdateInput, "id">;
			type CreateLocationInput = Prisma.LocationCreateInput;

			const addLocationForm = document.getElementById("addLocationForm") as HTMLFormElement;

			addLocationForm?.addEventListener("submit", async (e) => {
				e.preventDefault();
				const msg = document.getElementById("addLocationMsg")!;
				msg.textContent = "";
				msg.className = "mt-3 text-center";

				const formData = Object.fromEntries(new FormData(addLocationForm).entries());

				const newLocationData: CreateLocationInput = {
					name: (formData.name as string) || "Untitled",
					spotCapacity: Number(formData.spotCapacity),
					spotAvailability: Number(formData.spotCapacity), // Initially same
					type: formData.locationType as Type,
					timeLimitSecs: formData.timeLimitSecs ? Number(formData.timeLimitSecs) : null,
					address: {
						create: {
							number: Number(formData.number),
							street: formData.street as string,
							city: formData.city as string,
							state: formData.state as string,
							zip: Number(formData.zip),
						},
					},
				};
				try {
					const response = await fetch("/api/location/add", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(newLocationData),
					});
					if (!response.ok) throw new Error("Failed to add location");

					msg.textContent = "Location added successfully!";
					msg.classList.add("alert", "alert-success");

					addLocationForm.reset();
					const addModalEl = document.getElementById("addLocationModal");

					// @ts-ignore
					const addModal = bootstrap.Modal.getInstance(addModalEl);
					addModal?.hide();

					window.location.reload();
				} catch (err) {
					console.error("Error adding location:", err);
					msg.textContent = "Something went wrong. Please try again.";
					msg.classList.add("alert", "alert-danger");
				}
			});

			// --- Utility Function ---
			function formatTime(seconds: number) {
				const secs = Math.floor(seconds) % 60;
				const mins = Math.floor(seconds / 60) % 60;
				const hours = Math.floor(seconds / (60 * 60)) % 24;
				const days = Math.floor(seconds / (60 * 60 * 24));

				if (days > 0)
					return `${days} days ${hours}:${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
				return `${hours}:${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
			}

			// --- Timer Variables ---
			let timerInterval: NodeJS.Timeout;
			let startTime: number;
			let currentLimit: number | null = null;
			let currentAddress = "";
			let currentType = "";
			let currentID = 0;

			const display = document.getElementById("timerDisplay")!.querySelector("span");
			const confirmBtn = document.getElementById("stayYesBtn");
			const leaveBtn = document.getElementById("leaveBtn");
			const stayModalEl = document.getElementById("stayModal");

			// --- Restore Timer on Page Load ---
			window.addEventListener("load", () => {
				const savedStart = localStorage.getItem("stayStartTime");
				const savedLimit = localStorage.getItem("stayTimeLimit");
				const savedAddress = localStorage.getItem("stayAddress");
				const savedType = localStorage.getItem("stayType");
				const savedID = localStorage.getItem("stayLocationID");

				if (savedStart) {
					startTime = parseInt(savedStart);
					currentLimit = savedLimit != null ? parseInt(savedLimit) : null;
					currentAddress = savedAddress || "";
					currentType = savedType || "";
					currentID = parseInt(savedID || "0");
					runTimer();
				}
			});

			// --- Modal Logic: capture type, address & time limit ---
			stayModalEl!.addEventListener("show.bs.modal", (event: any) => {
				const triggerCard = event.relatedTarget;
				const name = triggerCard.dataset.name || "Unknown Location";
				const address = triggerCard.dataset.address || "";
				const type = triggerCard.dataset.kind || "";
				currentLimit = triggerCard.dataset.timelimit ? parseInt(triggerCard.dataset.timelimit) : null;
				currentAddress = address;
				currentType = type;
				currentID = parseInt(triggerCard.dataset.lotid || "0");

				document.getElementById("stayLocationText")!.textContent = name + (address ? "\n" + address : "");
			});

			// --- Confirm Stay (Start Timer) ---
			confirmBtn!.addEventListener("click", () => {
				console.log("OCCUPYING SPOT");
				clearInterval(timerInterval);
				startTime = Date.now();

				// Save state to localStorage
				localStorage.setItem("stayLocationID", currentID.toString());
				localStorage.setItem("stayStartTime", startTime.toString());
				localStorage.setItem("stayTimeLimit", currentLimit?.toString() || "");
				localStorage.setItem("stayAddress", currentAddress);
				localStorage.setItem("stayType", currentType);

				runTimer();

				// Tell server to start timer
				const payload: CreateTimerRequest = {
					locationID: currentID,
					seconds: currentLimit ? currentLimit / 1000 : undefined,
				};
				fetch("/api/timer", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(payload),
					credentials: "include",
				}).catch((err) => {
					console.error(err);
				});
				console.log("OCCUPYING SPOT");

				fetch(`/api/location/occupy/${currentID}`, {
					method: "PATCH",
					headers: { "Content-Type": "application/json" },
					credentials: "include",
				}).catch((err) => {
					console.error(err);
				});

				// Close modal programmatically
				// @ts-ignore
				const modal = bootstrap.Modal.getInstance(stayModalEl);
				modal.hide();
				window.location.reload();
			});

			// --- Leave (Stop Timer) ---
			leaveBtn!.addEventListener("click", () => {
				clearInterval(timerInterval);
				display!.textContent = "You Have Left The Location";

				// Tell server to stop timer
				fetch("/api/timer", {
					method: "DELETE",
					credentials: "include",
				}).catch((err) => {
					console.error(err);
				});
				console.log("LEAVING SPOT");
				fetch(`/api/location/leave/${currentID}`, {
					method: "PATCH",
					headers: { "Content-Type": "application/json" },
					credentials: "include",
				}).catch((err) => {
					console.error(err);
				});

				// Clear saved state
				localStorage.removeItem("stayLocationID");
				localStorage.removeItem("stayStartTime");
				localStorage.removeItem("stayTimeLimit");
				localStorage.removeItem("stayAddress");
				localStorage.removeItem("stayType");

				setTimeout(() => {
					window.location.reload();
				}, 1500);
			});

			// --- Timer Runner ---
			function runTimer() {
				clearInterval(timerInterval);

				if (currentLimit) {
					// Countdown mode
					let remaining = currentLimit - Math.floor((Date.now() - startTime) / 1000);
					if (remaining < 0) remaining = 0;

					display!.textContent = `${currentType == "PARKING_LOT" ? "Parking Lot" : "Bike Rack"} — ${currentAddress} — ${formatTime(remaining)} remaining`;

					timerInterval = setInterval(() => {
						remaining--;
						display!.textContent = `${currentType == "PARKING_LOT" ? "Parking Lot" : "Bike Rack"} — ${currentAddress} — ${formatTime(remaining)} remaining`;

						if (remaining <= 0) {
							clearInterval(timerInterval);
							display!.textContent = "Time limit reached!";
							localStorage.removeItem("stayLocationID");
							localStorage.removeItem("stayStartTime");
							localStorage.removeItem("stayTimeLimit");
							localStorage.removeItem("stayAddress");
							localStorage.removeItem("stayType");
						}
					}, 1000);
				} else {
					// Elapsed mode: show type + address + elapsed time
					timerInterval = setInterval(() => {
						const elapsed = Math.floor((Date.now() - startTime) / 1000);
						display!.textContent = `${currentType == "PARKING_LOT" ? "Parking Lot" : "Bike Rack"} — ${currentAddress} — ${formatTime(elapsed)}`;
					}, 1000);
				}
			}

			const editModal = document.getElementById("editModal");
			var locationID: number;

			//populates the form feilds with data from the element(location) that was clicked on
			if (editModal) {
				editModal.addEventListener("show.bs.modal", (event: any) => {
					const location = JSON.parse(event.relatedTarget.dataset.location) as LocationAddress;
					const address = location.address;
					locationID = location.id;
					const spotsUsed = location.spotCapacity - location.spotAvailability;

					(document.getElementById("modalName") as HTMLInputElement).value = location.name || "";

					(document.getElementById("modalNumber") as HTMLInputElement).value = String(address.number) || "";

					(document.getElementById("modalStreet") as HTMLInputElement).value = String(address.street) || "";

					(document.getElementById("modalCity") as HTMLInputElement).value = address.city || "";

					(document.getElementById("modalState") as HTMLInputElement).value = address.state || "";

					(document.getElementById("modalZip") as HTMLInputElement).value = String(address.zip) || "";

					(document.getElementById("modalKind") as HTMLSelectElement).value = location.type || "NONE";

					(document.getElementById("modalPermit") as HTMLSelectElement).value = location.permit || "NONE";

					(document.getElementById("modalUsed") as HTMLInputElement).value = String(spotsUsed) || "0";

					(document.getElementById("modalTotal") as HTMLInputElement).value = String(location.spotCapacity) || "0";

					(document.getElementById("modalTimeLimitSecs") as HTMLInputElement).value =
						String(location.timeLimitSecs) || "";
				});
			}

			//form on document
			const form = document.getElementById("editForm") as HTMLFormElement;
			const msg = document.getElementById("msg") as HTMLFormElement;
			//when the form is submitted, make update call to backend
			form.addEventListener("submit", async (e) => {
				e.preventDefault();

				const locationUpdates: UpdateLocationInput = {
					name: (document.getElementById("modalName") as HTMLInputElement).value,
					address: {
						update: {
							number: Number((document.getElementById("modalNumber") as HTMLInputElement).value),
							street: (document.getElementById("modalStreet") as HTMLInputElement).value,
							city: (document.getElementById("modalCity") as HTMLInputElement).value,
							state: (document.getElementById("modalState") as HTMLInputElement).value,
							zip: Number((document.getElementById("modalZip") as HTMLInputElement).value),
						},
					},
					type: (document.getElementById("modalKind") as HTMLSelectElement).value as Type,
					permit: (document.getElementById("modalPermit") as HTMLSelectElement).value as Permit,
					spotCapacity: Number((document.getElementById("modalTotal") as HTMLInputElement).value),
					spotAvailability:
						Number((document.getElementById("modalTotal") as HTMLInputElement).value) -
						Number((document.getElementById("modalUsed") as HTMLInputElement).value),
					timeLimitSecs: Number((document.getElementById("modalTimeLimitSecs") as HTMLInputElement).value) || null,
				};

				try {
					const updateCall = await fetch(`/api/location/${locationID}`, {
						method: "PATCH",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ data: locationUpdates }),
						credentials: "include",
					});

					if (!updateCall.ok) throw new Error(`Save failed: ${updateCall.status} ${updateCall.statusText}`);

					window.location.reload();
				} catch (err) {
					console.error(err);
					msg.textContent = "Something went wrong saving your changes. Please try again.";
				}
			});

			$(function () {
				function applyFilters() {
					const q = ($("#search").val() ?? "").toString().toLowerCase().trim();
					const avail = $("#avail").val();
					const type = $("#type").val();
					const permit = ($("#permit").val() ?? "").toString().toLowerCase();

					let visible = 0;

					$(".lotCard").each(function () {
						const $card = $(this);
						const name = ($card.data("name") || "").toLowerCase();
						const address = ($card.data("address") || "").toLowerCase();
						const kind = $card.data("kind");
						const cardPermit = ($card.data("permit") || "").toLowerCase();
						const isAvailable = $card.data("available") === true || $card.data("available") === "true";

						const matchText = !q || name.includes(q) || address.includes(q);
						const matchType = !type || kind === type;
						const matchPermit = !permit || cardPermit === permit;
						const matchAvail = !avail || (avail === "available" && isAvailable) || (avail === "full" && !isAvailable);

						const show = matchText && matchType && matchPermit && matchAvail;
						$card.toggle(show);
						if (show) visible++;
					});

					$("#empty").toggle(visible === 0);
				}

				$("#search, #avail, #type, #permit").on("input change", applyFilters);
				$("#resetFilters").on("click", function (e) {
					e.preventDefault();
					$("#search, #avail, #type, #permit").val("");
					applyFilters();
				});

				applyFilters();
			});
		</script>
	</div>
</BaseLayout>
