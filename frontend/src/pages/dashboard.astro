---
import BaseLayout from "src/layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Filter from "../components/FilterComponent.astro";
import ColorScore from "../components/ColorScore.astro";
import type { Location } from "@openspot/shared";
import "../assets/styles/dashboard.css";

// Force the server to regenerate the page every request, rather than at `npm run build`.
export const prerender = false;
//request user session and makes sure it is vaild and active
var res = await fetch(`${Astro.url.origin}/api/user/profile`, {
	headers: {
		Cookie: `session=${Astro.cookies.get("session")?.value}`,
	},
});

//redirects user before the page load to the login page if they are not logged in
if (!res.ok) {
	return new Response(null, {
		status: 302,
		headers: {
			Location: "/",
		},
	});
}
const user = await res.json();

res = await fetch(`${Astro.url.origin}/api/location/getAll`, {
	headers: {
		Cookie: `session=${Astro.cookies.get("session")?.value}`,
	},
});

var lots = await res.json(); 

if (!res.ok) {
	lots = [];
}



// Title of the page, to be shown on the internet tab and at the top of the page
const title = "Dashboard";
//the list of buttons to be given to the header
const buttonList = [{ label: "Profile", href: "/profile", class: "btn btn-outline-light" }];
//if the user is an Admin the will see the admin dashboard button
if (user.role === "ADMIN") {
	buttonList.push({ label: "Admin", href: "/admin", class: "btn btn-outline-light" });
}

//Available Filter options
const availOptions = [
	{ label: "All", value: "" },
	{ label: "Available Spots", value: "available" },
	{ label: "Full", value: "full" },
];
//Type Filter options
const typeOptions = [
	{ label: "Any", value: "" },
	{ label: "Parking", value: "PARKING_LOT" },
	{ label: "Bike Rack", value: "BIKE_RACK" },
];
//Permit Filter options
const permitOptions = [
	{ label: "Any", value: "" },
	{ label: "None", value: "NONE" },
	{ label: "Commuter", value: "COMMUTER" },
	{ label: "Employee", value: "EMPLOYEE" },
	{ label: "Garage Zone", value: "GARAGE" },
];

const clamp = (n: number, a: number, b: number): number => Math.max(a, Math.min(b, n));
const pct = (used: number, total: number): number => (total > 0 ? clamp(Math.round((used / total) * 100), 0, 100) : 0);
const occ = (p: number): "green" | "yellow" | "red" => (p >= 100 ? "red" : p >= 50 ? "yellow" : "green");
const permitLabel = (kind: "Parking" | "Bike", permit: string | null): string =>
	kind === "Parking" ? permit || "—" : "None";

const occStyles = {
	green: { bg: "#11341e", br: "#2fb36a", fg: "#eafff1" },
	yellow: { bg: "#3b2a0e", br: "#f5a623", fg: "#fff4cf" },
	red: { bg: "#3a1515", br: "#f06464", fg: "#ffe3e3" },
};
---

<BaseLayout title={`Open Spot — ${title}`}>
	<div class="container py-4">
		<NavBar title={title} buttonList={buttonList} />

		<!-- Filters -->
		<section
			class="card shadow-lg rounded-4 border"
			style="background:linear-gradient(180deg,#111936,#0e1530); border-color:rgba(255,255,255,.10);"
		>
			<div class="p-3 d-grid gap-3">
				<Filter
					searchLabel="Search"
					availOptions={availOptions}
					typeOptions={typeOptions}
					permitOptions={permitOptions}
					onSubmit="#"
				/>
				<ColorScore />
			</div>
		</section>

		<!-- List -->
		<section class="d-grid gap-4 mt-4" id="list">
			{
				lots.map((lot: Location) => {
					const used = lot.spotCapacity - lot.spotAvailability;
					const total = lot.spotCapacity;
					const p = pct(used, total);
					const state = occ(p);
					const style = occStyles[state];
					const occText = total > 0 ? `${used}/${total} spots full` : "—";
					const typeText = lot.type === "PARKING_LOT" ? "Parking Lot" : lot.type === "BIKE_RACK" ? "Bike Rack" : "None";
					const permitTxt = lot.permit;
					const isAvailable = total > used ? "true" : "false";
					const addressString = lot.address.number + " " + lot.address.street + " " + lot.address.city + ", " + lot.address.state + " " + lot.address.zip;
					return (
						<article
							class="card p-3 rounded-4 border lotCard"
							data-name={lot.name}
							data-address={addressString}
							data-kind={lot.type}
							data-permit={permitTxt}
							data-available={isAvailable}
							style={`background:${style.bg}; color:${style.fg}; border-color:${style.br};`}
						>
							<div class="d-grid gap-3" style="grid-template-columns:1fr auto;">
								<div class="d-grid gap-1">
									<div class="fw-bold lh-sm">{lot.name}</div>
									<div class="small text-opacity-75">{addressString}</div>
									<div class="d-flex flex-wrap gap-2">
										<span class="badge rounded-pill border" style="background:rgba(255,255,255,.08);">
											{typeText}
										</span>
										<span class="badge rounded-pill border" style="background:rgba(255,255,255,.08);">
											Permit: {permitTxt}
										</span>
										<span class="badge rounded-pill border" style="background:rgba(255,255,255,.08);">
											{occText}
										</span>
									</div>
								</div>
								<div class="text-end d-grid gap-2" style="align-items: start;">
											<div
												class="fw-bold fs-5 px-3 py-2 rounded-pill border"
												style="background:rgba(0,0,0,.25); border-color:rgba(255,255,255,.28);"
											>
												{p}%
											</div>
									{user.role === "ADMIN" && (
										<button
											class="editBtn"
											data-bs-toggle="modal"
											data-bs-target="#editModal"
											data-lot-id={lot.id}
											data-lot-name={lot.name}
											data-lot-number={lot.address.number}
											data-lot-street={lot.address.street}
											data-lot-city={lot.address.city}
											data-lot-state={lot.address.state}
											data-lot-zip={lot.address.zip}
											data-lot-kind={lot.type}
											data-lot-permit={lot.permit || 'None'}
											data-lot-used={used}
											data-lot-total={total}
											title="Edit location"
											aria-label="Edit location"
											>
											<i class="bi bi-pencil"></i>
											</button>
									)}
											<a
												class="navIcon mt-2"
												href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addressString || lot.name)}`}
												target="_blank"
												rel="noopener noreferrer"
												title="Open in Google Maps"
												aria-label={`Open ${addressString || lot.name} in Google Maps`}
											>
												<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
													<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="currentColor" />
													<circle cx="12" cy="9" r="2.5" fill="#05122a" />
												</svg>
											</a>
									</div>
							</div>
							<div class="progress rounded-pill bg-dark-subtle mt-3" style="height:8px;">
								<div class="progress-bar" role="progressbar" style={`width:${p}%; background:rgba(255,255,255,.92);`} />
							</div>
						</article>
					);
				})
			}
		</section>

		<div class="text-center py-4 text-muted" id="empty" style="display:none">No locations match your filters.</div>
	</div>

	<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-white rounded-3">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Edit Location</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="modalName" class="form-label">Location Name</label>
            <input type="text" class="form-control" id="modalName" name="name" required>
          </div>
          <div class="mb-3">
			<label for="modalNumber" class="form-label">Number</label>
			<input type="text" class="form-control" id="modalNumber" name="number" required>
			</div>
			<div class="mb-3">
			<label for="modalStreet" class="form-label">Street</label>
			<input type="text" class="form-control" id="modalStreet" name="street" required>
			</div>
			<div class="mb-3">
			<label for="modalCity" class="form-label">City</label>
			<input type="text" class="form-control" id="modalCity" name="city" required>
			</div>
			<div class="mb-3">
			<label for="modalState" class="form-label">State</label>
			<input type="text" class="form-control" id="modalState" name="state" required>
			</div>
			<div class="mb-3">
			<label for="modalZip" class="form-label">Zip</label>
			<input type="number" class="form-control" id="modalZip" name="zip" required>
			</div>
          <div class="mb-3">
            <label for="modalKind" class="form-label">Type</label>
            <select class="form-select" id="modalKind" name="kind" required>
              <option value="PARKING_LOT">Parking Lot</option>
              <option value="BIKE_RACK">Bike Rack</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="modalPermit" class="form-label">Permit Required</label>
            <select class="form-select" id="modalPermit" name="permit">
              <option value="NONE">None</option>
              <option value="COMMUTER">Commuter</option>
              <option value="EMPLOYEE">Employee</option>
              <option value="GARAGE">Garage Zone</option>
            </select>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="modalUsed" class="form-label">Spots Used</label>
              <input type="number" class="form-control" id="modalUsed" name="used" min="0" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="modalTotal" class="form-label">Total Spots</label>
              <input type="number" class="form-control" id="modalTotal" name="total" min="0" required>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
	const editModal = document.getElementById('editModal');

if (editModal) {
  editModal.addEventListener('show.bs.modal', (event: any) => {
    const btn = event.relatedTarget as HTMLElement;

    (document.getElementById('modalName') as HTMLInputElement).value =
      btn.dataset.lotName || '';

    (document.getElementById('modalNumber') as HTMLInputElement).value =
      btn.dataset.lotNumber || '';

    (document.getElementById('modalStreet') as HTMLInputElement).value =
      btn.dataset.lotStreet || '';

    (document.getElementById('modalCity') as HTMLInputElement).value =
      btn.dataset.lotCity || '';

    (document.getElementById('modalState') as HTMLInputElement).value =
      btn.dataset.lotState || '';

    (document.getElementById('modalZip') as HTMLInputElement).value =
      btn.dataset.lotZip || '';

    (document.getElementById('modalKind') as HTMLSelectElement).value =
      btn.dataset.lotKind || 'Parking';

    (document.getElementById('modalPermit') as HTMLSelectElement).value =
      btn.dataset.lotPermit || 'None';

    (document.getElementById('modalUsed') as HTMLInputElement).value =
      btn.dataset.lotUsed || '0';

    (document.getElementById('modalTotal') as HTMLInputElement).value =
      btn.dataset.lotTotal || '0';
  });
}

		$(function () {
			function applyFilters() {
				const q = ($("#search").val() ?? "").toString().toLowerCase().trim();
				const avail = $("#avail").val();
				const type = $("#type").val();
				const permit = ($("#permit").val() ?? "").toString().toLowerCase();

				let visible = 0;

				$(".lotCard").each(function () {
					const $card = $(this);
					const name = ($card.data("name") || "").toLowerCase();
					const address = ($card.data("address") || "").toLowerCase();
					const kind = $card.data("kind");
					const cardPermit = ($card.data("permit") || "").toLowerCase();
					const isAvailable = $card.data("available") === true || $card.data("available") === "true";

					const matchText = !q || name.includes(q) || address.includes(q);
					const matchType = !type || kind === type;
					const matchPermit = !permit || cardPermit === permit;
					const matchAvail = !avail || (avail === "available" && isAvailable) || (avail === "full" && !isAvailable);

					const show = matchText && matchType && matchPermit && matchAvail;
					$card.toggle(show);
					if (show) visible++;
				});

				$("#empty").toggle(visible === 0);
			}

			$("#search, #avail, #type, #permit").on("input change", applyFilters);
			$("#resetFilters").on("click", function (e) {
				e.preventDefault();
				$("#search, #avail, #type, #permit").val("");
				applyFilters();
			});

			applyFilters();
		});
	</script>
</BaseLayout>
