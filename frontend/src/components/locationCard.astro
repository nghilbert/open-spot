---
import type { Prisma, User } from "@prisma/client";
import RightHandSideTop from "./locationCard/RightHandSideTop.astro";
import LeftHandSideTop from "./locationCard/LeftHandSideTop.astro";
import ProgressBar from "./locationCard/progressBar.astro";

 
type LocationAddress = Prisma.LocationGetPayload<{ include: { address: true }}>;

interface Props {
	user: User;
	locations: LocationAddress[];
	pct: (used: number, total: number) => number;
	occ: (p: number) => "green" | "yellow" | "red";
	occStyles: {
		green: {
			bg: string;
			br: string;
			fg: string;
		};
		yellow: {
			bg: string;
			br: string;
			fg: string;
		};
		red: {
			bg: string;
			br: string;
			fg: string;
		};
	};
}

const { user, locations, pct, occ, occStyles } = Astro.props;
---

<section class="d-grid gap-4 mt-4" id="list">
	{
		locations.map((location) => {
			const used = location.spotCapacity - location.spotAvailability;
			const total = location.spotCapacity;
			const p = pct(used, total);
			const state = occ(p);
			const style = occStyles[state];
			const occText = total > 0 ? `${used}/${total} Spots Used` : "â€”";
			const typeText =
				location.type === "PARKING_LOT" ? "Parking Lot" : location.type === "BIKE_RACK" ? "Bike Rack" : "None";
			const permitTxt = location.permit;
			const isAvailable = total > used ? "true" : "false";
			const addressString =
				location.address.number +
				" " +
				location.address.street +
				" " +
				location.address.city +
				", " +
				location.address.state +
				" " +
				location.address.zip;
			return (
				<article
					class="card p-3 rounded-4 border lotCard"
					data-bs-toggle="modal"
					data-bs-target="#stayModal"
					data-name={location.name}
					data-address={addressString}
					data-kind={location.type}
					data-permit={permitTxt}
					data-available={isAvailable}
					data-timelimit={location.timeLimitSecs || ""}
					data-lotID={location.id}
					style={`background:${style.bg}; color:${style.fg}; border-color:${style.br};`}
				>
					<div class="d-grid gap-3" style="grid-template-columns:1fr auto;">
						<RightHandSideTop
							location={location}
							addressString={addressString}
							typeText={typeText}
							permitTxt={permitTxt}
							occText={occText}
						/>
						<LeftHandSideTop
							user={user}
							location={location}
							addressString={addressString}
							used={used}
							total={total}
							p={p}
						/>
					</div>
					<ProgressBar p={p} />
				</article>
			);
		})
	}
</section>

<div class="text-center py-4 text-muted" id="empty" style="display:none">No locations match your filters.</div>
